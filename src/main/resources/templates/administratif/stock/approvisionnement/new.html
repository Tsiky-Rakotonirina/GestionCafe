<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head('Nouvel Approvisionnement')">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div th:replace="fragments/stock-sidebar :: sidebar('approvisionnement')"></div>

<div class="main-content">
    <header th:replace="fragments/header :: header('Approvisionner en ' + ${matiere.nom})"></header>

    <main class="content">
        <div class="container-fluid">
            <div class="card modern-card">
                <div class="card-header">
                    <h2><i class="fas fa-cart-plus me-2"></i>Détails de l'approvisionnement</h2>
                </div>
                <div class="card-body">
                    <form th:action="@{/administratif/stock/approvisionnement/save}" method="post" id="approForm">
                        <input type="hidden" name="idMatierePremiere" th:value="${matiere.id}">

                        <!-- Informations sur la matière première -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="info-card">
                                    <div class="info-header">
                                        <i class="fas fa-boxes me-2"></i>
                                        <h5>Matière Première: <span th:text="${matiere.nom}"></span></h5>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label"><i class="fas fa-warehouse me-1"></i>Stock actuel</label>
                                            <div class="form-control-plaintext fw-bold text-primary"
                                                 th:text="${matiere.stock} + ' ' + ${matiere.unite.getNom()}"></div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="quantite" class="form-label"><i class="fas fa-plus-circle me-1"></i>Quantité à ajouter</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" class="form-control" id="quantite" name="quantite" required>
                                                <span class="input-group-text" th:text="${matiere.unite.getNom()}"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informations fournisseur -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="fournisseur" class="form-label"><i class="fas fa-truck me-1"></i>Fournisseur</label>
                                <select class="form-select" id="fournisseur" name="idFournisseur" required>
                                    <option value="">Sélectionner un fournisseur</option>
                                    <option th:each="fournisseur : ${fournisseurs}"
                                            th:value="${fournisseur.id}"
                                            th:attr="data-prix=${fournisseur.prixUnitaire}, data-frais=${fournisseur.frais}"
                                            th:text="${fournisseur.nom} + ' - ' + ${#numbers.formatDecimal(fournisseur.prixUnitaire, 1, 2)} + ' Ar'">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="reference" class="form-label"><i class="fas fa-file-invoice me-1"></i>Référence Facture</label>
                                <input type="text" class="form-control" id="reference" name="referenceFacture" required>
                            </div>
                        </div>

                        <!-- Calculs financiers -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-tag me-1"></i>Prix Unitaire</label>
                                <div class="form-control-plaintext text-info fw-bold" id="prixUnitaire">0 Ar</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-money-bill-wave me-1"></i>Frais</label>
                                <div class="form-control-plaintext text-warning fw-bold" id="frais">0 Ar</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label"><i class="fas fa-calculator me-1"></i>Total</label>
                                <div class="form-control-plaintext text-success fw-bold fs-5" id="total">0 Ar</div>
                                <input type="hidden" id="totalValue" name="total">
                            </div>
                        </div>

                        <!-- Date d'approvisionnement -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="dateAppro" class="form-label"><i class="fas fa-calendar me-1"></i>Date d'approvisionnement</label>
                                <input type="date" class="form-control" id="dateAppro" name="dateApprovisionnement"
                                       th:value="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}" required>
                            </div>
                        </div>

                        <!-- Effet sur le stock -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="info-card bg-light">
                                    <div class="info-header">
                                        <i class="fas fa-chart-line me-2"></i>
                                        <h5>Effet sur le stock</h5>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label"><i class="fas fa-warehouse me-1"></i>Stock actuel</label>
                                            <div class="form-control-plaintext fw-bold text-secondary" id="stockActuel"
                                                 th:text="${matiere.stock} + ' ' + ${matiere.unite.getNom()}"></div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label"><i class="fas fa-plus me-1"></i>Quantité ajoutée</label>
                                            <div class="form-control-plaintext fw-bold text-primary" id="quantiteAjoutee">0</div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label"><i class="fas fa-boxes me-1"></i>Nouveau stock</label>
                                            <div class="form-control-plaintext fw-bold text-success fs-5" id="nouveauStock"
                                                 th:text="${matiere.stock} + ' ' + ${matiere.unite.getNom()}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary btn-modern" onclick="history.back()">
                                <i class="fas fa-arrow-left me-2"></i>Retour
                            </button>
                            <div>
                                <button type="button" class="btn btn-info btn-modern me-2" id="exportPdf">
                                    <i class="fas fa-file-pdf me-2"></i>Exporter en PDF
                                </button>
                                <button type="submit" class="btn btn-success btn-modern">
                                    <i class="fas fa-save me-2"></i>Enregistrer l'approvisionnement
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>

<script th:src="@{/bootstrap5/js/bootstrap.bundle.js}"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const fournisseurSelect = document.getElementById('fournisseur');
    const quantiteInput = document.getElementById('quantite');
    const prixUnitaireDiv = document.getElementById('prixUnitaire');
    const fraisDiv = document.getElementById('frais');
    const totalDiv = document.getElementById('total');
    const totalValueInput = document.getElementById('totalValue');
    const quantiteAjouteeDiv = document.getElementById('quantiteAjoutee');
    const nouveauStockDiv = document.getElementById('nouveauStock');
    const stockActuel = parseFloat(document.getElementById('stockActuel').textContent);

    // Mettre à jour les calculs quand les valeurs changent
    function updateCalculs() {
        const selectedOption = fournisseurSelect.options[fournisseurSelect.selectedIndex];
        const prix = selectedOption ? parseFloat(selectedOption.dataset.prix) || 0 : 0;
        const frais = selectedOption ? parseFloat(selectedOption.dataset.frais) || 0 : 0;
        const quantite = parseFloat(quantiteInput.value) || 0;

        // Mettre à jour les affichages
        prixUnitaireDiv.textContent = prix.toFixed(2) + ' Ar';
        fraisDiv.textContent = frais.toFixed(2) + ' Ar';

        // Calculer le total
        const total = (prix * quantite) + frais;
        totalDiv.textContent = total.toFixed(2) + ' Ar';
        totalValueInput.value = total;

        // Mettre à jour les infos de stock
        const unite = document.getElementById('stockActuel').textContent.split(' ')[1];
        quantiteAjouteeDiv.textContent = quantite + ' ' + unite;
        const nouveauStock = stockActuel + quantite;
        nouveauStockDiv.textContent = nouveauStock.toFixed(2) + ' ' + unite;
    }

    // Écouteurs d'événements
    fournisseurSelect.addEventListener('change', updateCalculs);
    quantiteInput.addEventListener('input', updateCalculs);

    // Export PDF
    document.getElementById('exportPdf').addEventListener('click', function () {
        const {jsPDF} = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.text('Bon d\'approvisionnement', 20, 20);
        
        doc.setFontSize(12);
        doc.text('Matière première: ' + document.querySelector('h5 span').textContent, 20, 40);
        doc.text('Fournisseur: ' + (fournisseurSelect.options[fournisseurSelect.selectedIndex]?.text || ''), 20, 50);
        doc.text('Quantité: ' + (quantiteInput.value || '0'), 20, 60);
        doc.text('Prix unitaire: ' + prixUnitaireDiv.textContent, 20, 70);
        doc.text('Frais: ' + fraisDiv.textContent, 20, 80);
        doc.text('Total: ' + totalDiv.textContent, 20, 90);
        doc.text('Référence facture: ' + document.getElementById('reference').value, 20, 100);
        doc.text('Date: ' + document.getElementById('dateAppro').value, 20, 110);

        doc.save('approvisionnement_' + new Date().toISOString().slice(0, 10) + '.pdf');
    });

    // Form validation
    document.getElementById('approForm').addEventListener('submit', function(e) {
        if (!fournisseurSelect.value || !quantiteInput.value || !document.getElementById('reference').value) {
            e.preventDefault();
            alert('Veuillez remplir tous les champs obligatoires.');
        }
    });
});
</script>
</body>
</html>
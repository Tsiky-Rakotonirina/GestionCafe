<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${produit.id == null ? 'Ajouter un produit' : 'Modifier un produit'}">Produit</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/templates/styles.css}">
    <style>
        .form-flex-container {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
        }
        .form-main-fields {
            flex: 1 1 0;
            min-width: 0;
        }
        .form-ingredients-box {
            flex: 1 1 0;
            min-width: 0;
            background: rgba(139,69,19,0.04);
            border-radius: var(--border-radius, 12px);
            padding: 1.5rem;
            box-shadow: var(--box-shadow, 0 2px 8px rgba(0,0,0,0.04));
        }
        .ingredient-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            align-items: center;
        }
        .ingredient-row select, .ingredient-row input {
            min-width: 100px;
        }
        .ingredient-row button {
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
<div th:replace="~{administratif/layout/sidebar :: sidebar}"></div>
<div class="main-content" id="mainContent">
    <div th:replace="~{administratif/layout/header :: header('Produits')}"></div>
    <main class="content">
        <!-- Modern Header -->
        <div class="page-header modern-header">
            <div class="header-content">
                <div class="header-title-section">
                    <div class="header-icon">
                        <i th:class="${produit.id == null ? 'fas fa-plus' : 'fas fa-edit'}"></i>
                    </div>
                    <div>
                        <h2 th:text="${produit.id == null ? 'Ajouter un produit' : 'Modifier un produit'}">Formulaire produit</h2>
                        <p class="header-subtitle" th:text="${produit.id == null ? 'Créer un nouveau produit' : 'Modifier les informations existantes'}">Gestion des produits</p>
                    </div>
                </div>
                <div class="header-actions">
                    <a th:href="@{/produits}" class="btn outline">
                        <i class="fas fa-arrow-left"></i>
                        Retour à la liste
                    </a>
                </div>
            </div>
        </div>

        <!-- Form Container -->
        <div class="chart-card hover-glow" style="max-width: 1100px; margin: 0 auto;">
            <div class="card-header">
                <h3>
                    <i th:class="${produit.id == null ? 'fas fa-plus-circle' : 'fas fa-edit'}"></i>
                    <span th:text="${produit.id == null ? 'Nouveau produit' : 'Modification'}">Formulaire</span>
                </h3>
            </div>
            <form th:action="@{/produits/save}"
                  th:object="${produit}" method="post" enctype="multipart/form-data"
                  style="padding: 2rem;">
                <div class="form-flex-container">
                    <!-- Left: Main fields -->
                    <div class="form-main-fields">
                        <!-- Nom Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-tag"></i>
                                Nom du produit
                            </label>
                            <input type="text" th:field="*{nom}" class="form-input"
                                   placeholder="Saisir le nom du produit..."
                                   required/>
                        </div>
                        <!-- Description Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-align-left"></i>
                                Description
                            </label>
                            <textarea th:field="*{description}" class="form-input" placeholder="Description du produit..."></textarea>
                        </div>
                        <!-- Unité Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-ruler"></i>
                                Unité de mesure
                            </label>
                            <select th:field="*{unite}" class="form-select" required>
                                <option value="">Choisir une unité...</option>
                                <option th:each="u : ${unites}"
                                        th:value="${u.id}"
                                        th:text="${u.nom}"
                                        th:selected="${produit.unite != null and u.id == produit.unite.id}">
                                </option>
                            </select>
                        </div>
                        <!-- Package Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-box"></i>
                                Package
                            </label>
                            <select th:field="*{packageProduit}" class="form-select" required>
                                <option value="">Choisir un package...</option>
                                <option th:each="p : ${packages}"
                                        th:value="${p.id}"
                                        th:text="${p.nom}"
                                        th:selected="${produit.packageProduit != null and p.id == produit.packageProduit.id}">
                                </option>
                            </select>
                        </div>
                        <!-- Stock Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-boxes"></i>
                                Stock initial
                            </label>
                            <input type="number" step="0.01" th:field="*{stock}" class="form-input" placeholder="Stock initial..." required/>
                        </div>
                        <!-- Délai de péremption Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-hourglass-half"></i>
                                Délai de péremption (jours)
                            </label>
                            <input type="number" step="1" th:field="*{delaiPeremption}" class="form-input" placeholder="Délai de péremption en jours"/>
                        </div>
                        <!-- Image Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-image"></i>
                                Image du produit
                            </label>
                            <input type="file" name="imageFile" class="form-input" accept="image/*"/>
                            <div th:if="${produit.image}" style="margin-top: 1rem;">
                                <div style="padding: 1rem; background: rgba(139, 69, 19, 0.05); border-radius: var(--border-radius); text-align: center;">
                                    <p style="margin-bottom: 1rem; color: var(--gray-600); font-size: 0.9rem;">
                                        <i class="fas fa-info-circle"></i>
                                        Image actuelle
                                    </p>
                                    <img th:src="@{${produit.image}}"
                                         alt="Image actuelle"
                                         style="max-width: 150px; max-height: 150px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 3px solid rgba(139, 69, 19, 0.2);"/>
                                </div>
                            </div>
                        </div>
                        <!-- Mode de calcul du prix de vente Field -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-euro-sign"></i>
                                Mode de calcul du prix de vente
                            </label>
                            <select name="modePrix" class="form-select" id="modePrixSelect" required onchange="togglePrixFields()">
                                <option value="coefficient">Calcul par coefficient</option>
                                <option value="manuel">Saisie manuelle</option>
                            </select>
                        </div>
                        <!-- Champ coefficient (affiché si modePrix = coefficient) -->
                        <div class="form-group" id="coefficientField" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-percentage"></i>
                                Coefficient multiplicateur
                            </label>
                            <input type="number" step="0.01" min="0" name="coefficient" class="form-input" placeholder="Coefficient (ex: 1.5)">
                        </div>
                        <!-- Champ prix de vente manuel (affiché si modePrix = manuel) -->
                        <div class="form-group" id="prixVenteManuelField" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-euro-sign"></i>
                                Prix de vente manuel (€)
                            </label>
                            <input type="number" step="0.01" min="0" name="prixVenteManuel" class="form-input" placeholder="Prix de vente">
                        </div>
                    </div>
                    <!-- Right: Ingrédients -->
                    <div class="form-ingredients-box">
                        <label class="form-label" style="font-weight: bold; font-size: 1.1rem;">
                            <i class="fas fa-list"></i>
                            Recette / Ingrédients
                        </label>
                        <div id="ingredients-list"></div>
                        <button type="button" class="btn outline small" onclick="addIngredientRow()"
                                style="margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Ajouter un ingrédient
                        </button>
                    </div>
                </div>
                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid rgba(139, 69, 19, 0.1);">
                    <a th:href="@{/produits}" class="btn outline">
                        <i class="fas fa-times"></i>
                        Annuler
                    </a>
                    <button type="submit" class="btn primary">
                        <i th:class="${produit.id == null ? 'fas fa-plus' : 'fas fa-save'}"></i>
                        <span th:text="${produit.id == null ? 'Créer' : 'Sauvegarder'}">Valider</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/
    // Sécurise l'initialisation pour éviter l'erreur si la variable est null
    var matieres = /*[[${matieresPremieres}]]*/ [];
    if (!matieres) matieres = [];
    var unites = /*[[${unites}]]*/ [];
    if (!unites) unites = [];

    // On suppose que chaque matierePremiere a un champ categorieUnite (objet avec id)
    // et chaque unite a un champ categorieUnite (objet avec id)

    function addIngredientRow(mpId, quantite, uniteId) {
        const list = document.getElementById('ingredients-list');
        const index = list.children.length;
        const row = document.createElement('div');
        row.className = 'ingredient-row';

        // Matière première
        const selectMp = document.createElement('select');
        selectMp.name = `ingredientsWrapper.ingredients[${index}].idMatierePremiere`;
        selectMp.required = true;
        selectMp.className = 'matiere-select';
        matieres.forEach(mp => {
            const opt = document.createElement('option');
            opt.value = mp.id;
            opt.text = mp.nom;
            if (mp.categorieUnite && mp.categorieUnite.id)
                opt.setAttribute('data-categorie', mp.categorieUnite.id);
            if (mpId && mp.id == mpId) opt.selected = true;
            selectMp.appendChild(opt);
        });

        // Quantité
        const inputQte = document.createElement('input');
        inputQte.type = 'number';
        inputQte.step = '0.01';
        inputQte.min = '0';
        inputQte.name = `ingredientsWrapper.ingredients[${index}].quantite`;
        inputQte.placeholder = 'Quantité';
        inputQte.required = true;
        if (quantite) inputQte.value = quantite;

        // Unité
        const selectUnite = document.createElement('select');
        selectUnite.name = `ingredientsWrapper.ingredients[${index}].idUnite`;
        selectUnite.required = true;
        selectUnite.className = 'unite-select';

        // Fonction pour filtrer les unités selon la catégorie de la matière première sélectionnée
        function filterUnites() {
            const selectedMp = selectMp.options[selectMp.selectedIndex];
            const categorieId = selectedMp ? selectedMp.getAttribute('data-categorie') : null;
            selectUnite.innerHTML = '';
            unites.forEach(u => {
                if (!u.categorieUnite || !u.categorieUnite.id) return;
                if (!categorieId || u.categorieUnite.id == categorieId) {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.text = u.nom;
                    opt.setAttribute('data-categorie', u.categorieUnite.id);
                    if (uniteId && u.id == uniteId) opt.selected = true;
                    selectUnite.appendChild(opt);
                }
            });
        }

        // Initialiser la liste des unités selon la matière première sélectionnée
        selectMp.addEventListener('change', function() {
            filterUnites();
        });

        // Initialiser la liste au chargement de la ligne
        filterUnites();

        // Bouton supprimer
        const btnRemove = document.createElement('button');
        btnRemove.type = 'button';
        btnRemove.textContent = 'Retirer';
        btnRemove.className = 'btn danger small';
        btnRemove.onclick = function() {
            row.remove();
            updateIngredientIndexes();
        };

        row.appendChild(selectMp);
        row.appendChild(inputQte);
        row.appendChild(selectUnite);
        row.appendChild(btnRemove);

        list.appendChild(row);
    }

    function updateIngredientIndexes() {
        const rows = document.querySelectorAll('#ingredients-list .ingredient-row');
        rows.forEach((row, idx) => {
            row.querySelectorAll('select, input').forEach(input => {
                if (input.name.includes('idMatierePremiere'))
                    input.name = `ingredientsWrapper.ingredients[${idx}].idMatierePremiere`;
                if (input.name.includes('quantite'))
                    input.name = `ingredientsWrapper.ingredients[${idx}].quantite`;
                if (input.name.includes('idUnite'))
                    input.name = `ingredientsWrapper.ingredients[${idx}].idUnite`;
            });
        });
    }

    function togglePrixFields() {
        var mode = document.getElementById('modePrixSelect').value;
        document.getElementById('coefficientField').style.display = (mode === 'coefficient') ? '' : 'none';
        document.getElementById('prixVenteManuelField').style.display = (mode === 'manuel') ? '' : 'none';
    }

    // Affiche le bon champ au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        togglePrixFields();
    });

    window.addIngredientRow = addIngredientRow;
    window.updateIngredientIndexes = updateIngredientIndexes;
    /*]]>*/
</script>
</body>
</html>

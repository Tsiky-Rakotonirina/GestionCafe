
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${machine.id == null ? 'Ajouter une machine' : 'Modifier la machine'}">Machine</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/templates/styles.css}">
    <style>
        .form-flex-container { display: flex; gap: 2rem; align-items: flex-start; }
        .form-main-fields { flex: 1 1 0; min-width: 0; }
        .form-ingredients-box { flex: 1 1 0; min-width: 0; background: rgba(139, 69, 19, 0.04); border-radius: var(--border-radius, 12px); padding: 1.5rem; box-shadow: var(--box-shadow, 0 2px 8px rgba(0, 0, 0, 0.04)); }
        .utilisation-group { 
            display: flex; 
            gap: 0.5rem; 
            margin-bottom: 0.75rem; 
            align-items: center; 
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(139, 69, 19, 0.1);
        }
        .utilisation-group input, .utilisation-group select { 
            min-width: 100px; 
            height: 36px;
            border: 1px solid rgba(139, 69, 19, 0.2);
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.9rem;
        }
        .utilisation-group button { 
            margin-left: 0.5rem; 
            height: 36px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .utilisation-group button i {
            font-size: 0.85rem;
        }
        .utilisation-group button.primary {
            background: var(--primary-color, #8B4513);
            color: white;
        }
        .utilisation-group button.primary:hover {
            background: var(--primary-dark, #6B3410);
        }
        .utilisation-group button.danger {
            background: var(--danger-color, #dc3545);
            color: white;
        }
        .utilisation-group button.danger:hover {
            background: var(--danger-dark, #c82333);
        }
        .utilisation-group button.small {
            font-size: 0.8rem;
            padding: 0.4rem;
        }
        #utilisationsExistantes h4 {
            color: var(--primary-color, #8B4513);
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div th:replace="~{administratif/production/layout/sidebar :: sidebar}"></div>
<div class="main-content" id="mainContent">
    <div th:replace="~{administratif/production/layout/header :: header('Machines')}"></div>
    <main class="content">
        <div class="page-header modern-header">
            <div class="header-content">
                <div class="header-title-section">
                    <div class="header-icon">
                        <i th:class="${machine.id == null ? 'fas fa-plus' : 'fas fa-edit'}"></i>
                    </div>
                    <div>
                        <h2 th:text="${machine.id == null ? 'Ajouter une machine' : 'Modifier la machine'}">Formulaire machine</h2>
                        <p class="header-subtitle" th:text="${machine.id == null ? 'Créer une nouvelle machine' : 'Modifier les informations existantes'}"></p>
                    </div>
                </div>
                <div class="header-actions">
                    <a th:href="@{/machines}" class="btn outline">
                        <i class="fas fa-arrow-left"></i> Retour à la liste
                    </a>
                </div>
            </div>
        </div>
        <div class="chart-card hover-glow" style="max-width: 900px; margin: 0 auto;">
            <div class="card-header">
                <h3>
                    <i th:class="${machine.id == null ? 'fas fa-plus-circle' : 'fas fa-edit'}"></i>
                    <span th:text="${machine.id == null ? 'Nouvelle machine' : 'Modification'}">Formulaire</span>
                </h3>
            </div>
            <form th:action="@{/machines/save}" th:object="${machine}" method="post" style="padding: 2rem;">
                <input type="hidden" th:field="*{id}" />
                <div class="form-flex-container">
                    <div class="form-main-fields">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-tag"></i> Nom</label>
                            <input type="text" th:field="*{nom}" class="form-input" placeholder="Nom de la machine..." required />
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-industry"></i> Marque</label>
                            <input type="text" th:field="*{marque}" class="form-input" placeholder="Marque..." />
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-bolt"></i> Puissance</label>
                            <input type="number" th:field="*{puissance}" step="0.01" class="form-input" placeholder="Puissance..." required />
                        </div>
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-percentage"></i> Taux d'activité (%)</label>
                            <input type="number" th:field="*{tauxActivite}" step="0.01" class="form-input" placeholder="Taux d'activité..." required />
                        </div>
                    </div>
                    <div class="form-ingredients-box">
                        <label class="form-label" style="font-weight: bold; font-size: 1.1rem;"><i class="fas fa-cogs"></i> Utilisations de la machine</label>
                        <div id="utilisationsContainer"></div>
                        <button type="button" class="btn outline small" onclick="addUtilisation()" style="margin-top: 1rem;"><i class="fas fa-plus"></i> Ajouter utilisation</button>
                        <div id="utilisationsExistantes" th:if="${machine.id != null}" style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem;">Utilisations existantes</h4>
                            <div th:each="u, idx : ${utilisationsExistantes}" class="utilisation-group">
                                <input type="hidden" name="utilisationsExistantesIds" th:value="${u.id}"/>
                                <input type="text" name="utilisationsExistantes.idProduit" th:value="${u.produit.nom}" list="produitsList" style="width:120px;" autocomplete="off"/>
                                <input type="number" name="utilisationsExistantes.duree" th:value="${u.duree}" step="0.01" required style="width:70px;"/>
                                <select name="utilisationsExistantes.idUnite" required style="width:80px;">
                                    <option value="" disabled>Unité</option>
                                    <option th:each="unite : ${unites}" th:value="${unite.id}" th:text="${unite.nom}" th:selected="${u.unite.id == unite.id}"></option>
                                </select>
                                <button type="submit" name="updateUtilisationId" th:value="${u.id}" class="btn primary small"><i class="fas fa-save"></i></button>
                                <button type="submit" name="deleteUtilisationId" th:value="${u.id}" class="btn danger small"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid rgba(139, 69, 19, 0.1);">
                    <a th:href="@{/machines}" class="btn outline">
                        <i class="fas fa-times"></i> Annuler
                    </a>
                    <button type="submit" class="btn primary">
                        <i th:class="${machine.id == null ? 'fas fa-plus' : 'fas fa-save'}"></i>
                        <span th:text="${machine.id == null ? 'Créer' : 'Sauvegarder'}">Valider</span>
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>
<datalist id="produitsList">
    <option th:each="p : ${produits}" th:value="${p.nom}" th:attr="data-id=${p.id}"></option>
</datalist>
<datalist id="unitesList">
    <option th:each="u : ${unites}" th:value="${u.nom}" th:attr="data-id=${u.id}"></option>
</datalist>
<script th:inline="javascript">
    /*<![CDATA[*/
    // Génère la liste des unités côté JS
    var unites = /*[[${unites}]]*/ [];
    function addUtilisation() {
        const container = document.getElementById('utilisationsContainer');
        const div = document.createElement('div');
        div.className = 'utilisation-group';
        
        // Génère dynamiquement les options du select
        let selectOptions = '<option value="" disabled selected>Unité</option>';
        for (let i = 0; i < unites.length; i++) {
            selectOptions += `<option value="${unites[i].id}">${unites[i].nom}</option>`;
        }
        
        div.innerHTML = `
            <input type="text" name="utilisations.idProduit" placeholder="Produit" list="produitsList" autocomplete="off"/>
            <input type="number" name="utilisations.duree" placeholder="Durée" step="0.01" required/>
            <select name="utilisations.idUnite" required>${selectOptions}</select>
            <button type="button" class="btn danger small" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
        `;
        container.appendChild(div);
    }
    document.querySelector('form').addEventListener('submit', function (e) {
        document.querySelectorAll('.utilisation-group').forEach(function (group) {
            const produitInput = group.querySelector('input[list="produitsList"]');
            if (produitInput) {
                const option = Array.from(document.getElementById('produitsList').options)
                    .find(opt => opt.value === produitInput.value);
                if (option) produitInput.value = option.getAttribute('data-id');
            }
            // Plus besoin de traitement pour l'unité car c'est un select
        });
    });
    /*]]>*/
</script>
</body>
</html>
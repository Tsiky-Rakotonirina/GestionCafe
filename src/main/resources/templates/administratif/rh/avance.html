<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CafeManager Pro - Gestion de Café</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" th:href="@{/templates/styles.css}">
    <link rel="stylesheet" th:href="@{/css/rh/historique.css}">
    <link rel="stylesheet" th:href="@{/css/rh/avance.css}">
    <script th:src="@{/js/rh/avance.js}"></script>
</head>

<body>
    <div th:replace="~{administratif/rh/layout/sidebar :: sidebar}"></div>
    <div class="main-content" id="mainContent">
        <div th:replace="~{administratif/rh/layout/header :: header('Gestion des avances')}"></div>
        <main class="content">
            <div class="advance-container">
                <!-- Employee Profile Card -->
                <div class="employee-profile-card">
                    <div class="employee-header">
                        <div class="employee-avatar">
                            <img th:src="${employe.image != null ? '/static/uploads/' + employe.image : ''}"
                                 alt="Photo de profil" class="avatar-img" th:if="${employe.image != null}">
                            <span th:if="${employe.image == null}" th:text="${#strings.substring(employe.nom, 0, 1)}">E</span>
                        </div>
                        <div class="employee-info">
                            <h4 class="employee-name">
                                <i class="fas fa-user me-2"></i>
                                <span th:text="${employe.nom != null ? employe.nom : 'Nom non défini'}">Nom de l'employé</span>
                            </h4>
                            <div class="employee-details">
                                <div class="detail-item">
                                    <i class="fas fa-calendar-alt text-primary"></i>
                                    <span class="detail-label">Recrutement :</span>
                                    <span class="detail-value" th:text="${employe.dateRecrutement != null ? #dates.format(employe.dateRecrutement, 'dd/MM/yyyy') : '-'}">-</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-venus-mars text-info"></i>
                                    <span class="detail-label">Genre :</span>
                                    <span class="detail-value" th:text="${employe.genre != null ? employe.genre.nom : '-'}">-</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-phone text-success"></i>
                                    <span class="detail-label">Contact :</span>
                                    <span class="detail-value" th:text="${employe.contact != null ? employe.contact : '-'}">-</span>
                                </div>
                            </div>
                        </div>
                        <div class="employee-actions">
                            <a th:href="@{'/administratif/rh/fiche-employe/' + ${employe.id}}" class="btn btn-primary">
                                <i class="fas fa-user-circle me-1"></i> Fiche Employé
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Advance Section -->
                <div class="advance-section">
                    <!-- Advance Form -->
                    <div class="advance-form-card">
                        <div class="form-header">
                            <h3><i class="fas fa-hand-holding-usd"></i> Accorder une avance</h3>
                        </div>
                        
                        <div class="salary-info">
                            <div class="salary-item">
                                <span class="salary-label">Prochain salaire disponible :</span>
                                <span class="salary-value" th:text="${prochainSalaire != null ? #numbers.formatDecimal(prochainSalaire, 0, 'COMMA', 2, 'POINT') + ' Ar' : 'Non disponible'}">-</span>
                            </div>
                            <div class="salary-item">
                                <span class="salary-label">Déjà retenu pour avances :</span>
                                <span class="salary-value" th:text="${retenuPourAvance != null ? #numbers.formatDecimal(retenuPourAvance, 0, 'COMMA', 2, 'POINT') + ' Ar' : '0 Ar'}">-</span>
                            </div>
                        </div>

                        <form th:action="@{/administratif/rh/salaire/ajout-avance}" method="post" class="advance-form">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-money-bill-wave me-1"></i> Montant de l'avance
                                </label>
                                <input type="number" class="form-input" placeholder="Ex : 50 000" name="montant"
                                       min="0" required>
                                <small class="form-help">Saisissez le montant en Ariary</small>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-info-circle me-1"></i> Raison de l'avance
                                </label>
                                <select class="form-select" name="idRaison" required>
                                    <option value="">Choisir une raison...</option>
                                    <option th:each="raisonAvance : ${raisonAvances}"
                                            th:value="${raisonAvance.id}"
                                            th:text="${raisonAvance.valeur}">
                                        Raison
                                    </option>
                                </select>
                            </div>
                            
                            <input type="hidden" name="idEmploye" th:value="${employe.id}">
                            <button type="submit" class="btn-submit">
                                <i class="fas fa-check-circle"></i>
                                Accorder l'avance
                            </button>
                        </form>
                    </div>

                    <!-- Advance Statistics -->
                    <div class="advance-stats-card">
                        <div class="stats-header">
                            <h3><i class="fas fa-chart-pie"></i> Statistiques</h3>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-list"></i>
                                </div>
                                <div class="stat-value" th:text="${#lists.size(avances ?: {})}">0</div>
                                <div class="stat-label">Avances accordées</div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-calculator"></i>
                                </div>
                                <div class="stat-value" th:text="${avances != null ? #aggregates.sum(avances.![montant]) + ' Ar' : '0 Ar'}">0 Ar</div>
                                <div class="stat-label">Total des avances</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advance History -->
                <div class="advance-history-card">
                    <div class="history-header">
                        <h3><i class="fas fa-history"></i> Historique des avances</h3>
                    </div>
                    
                    <div th:if="${avances != null and !#lists.isEmpty(avances)}">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar me-1"></i> Date</th>
                                    <th><i class="fas fa-money-bill-wave me-1"></i> Montant</th>
                                    <th><i class="fas fa-info-circle me-1"></i> Raison</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="avance : ${avances}">
                                    <td class="date-cell" th:text="${avance.dateAvance != null ? #dates.format(avance.dateAvance, 'dd/MM/yyyy') : '-'}">-</td>
                                    <td class="amount-cell" th:text="${avance.montant != null ? #numbers.formatDecimal(avance.montant, 0, 'COMMA', 2, 'POINT') + ' Ar' : '-'}">-</td>
                                    <td class="reason-cell">
                                        <span class="reason-badge" th:text="${avance.raisonAvance != null ? avance.raisonAvance.valeur : 'Non spécifiée'}">-</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div th:if="${avances == null or #lists.isEmpty(avances)}" class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <h4>Aucune avance accordée</h4>
                        <p>Aucune avance n'a encore été accordée à cet employé</p>
                    </div>
                </div>

                <!-- Error Messages -->
                <div th:if="${erreurAjoutAvance}" class="error-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span th:text="${erreurAjoutAvance}">Erreur lors de l'ajout de l'avance</span>
                </div>
            </div>
        </main>
    </div>
    <!-- <script th:src="@{/templates/script.js}"></script> -->
</body>

</html>